name: Prepare Release Branch

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: "リリース種別"
        required: true
        type: choice
        default: patch
        options:
          - major
          - minor
          - patch

jobs:
  create-release-branch:
    name: Create release branch and tag
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      VERSION_BUMP: ${{ inputs.version_bump }}
      PUSH_AND_RUN_WORKFLOW_TOKEN: ${{ secrets.PUSH_AND_RUN_WORKFLOW_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        run: |
          python -m pip install --upgrade pip
          python -m pip install uv

      - name: Determine next version
        run: |
          python .github/scripts/determine_next_version.py \
            --pyproject pyproject.toml \
            --bump "$VERSION_BUMP" \
            --env-file "$GITHUB_ENV"

      - name: Set release date
        run: echo "RELEASE_DATE=$(date +%Y-%m-%d)" >> "$GITHUB_ENV"
        env:
          TZ: "Asia/Tokyo"

      - name: Validate version
        run: |
          if [[ ! "$RELEASE_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$ ]]; then
            echo "release_version は SemVer (例: 0.2.0) 形式で指定してください。"
            exit 1
          fi

      - name: Ensure refs do not exist
        run: |
          if git ls-remote --exit-code origin "refs/heads/$RELEASE_BRANCH" >/dev/null 2>&1; then
            echo "Release branch $RELEASE_BRANCH は既に存在します。"
            exit 1
          fi
          if git ls-remote --exit-code origin "refs/tags/$RELEASE_TAG" >/dev/null 2>&1; then
            echo "Tag $RELEASE_TAG は既に存在します。"
            exit 1
          fi

      - name: Create branch from main
        run: |
          git fetch origin main
          git switch --create "$RELEASE_BRANCH" "origin/main"

      - name: Update pyproject version
        run: |
          python .github/scripts/update_pyproject_version.py \
            --pyproject pyproject.toml \
            --version "$RELEASE_VERSION"

      - name: Update lockfile
        run: uv lock

      - name: Update changelog
        run: |
          python .github/scripts/update_changelog.py \
            --changelog CHANGELOG.md \
            --version "$RELEASE_VERSION" \
            --date "$RELEASE_DATE"

      - name: Update version in README
        run: |
          python .github/scripts/update_readme_version.py \
            --readme README.md \
            --version "$RELEASE_VERSION"

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit changes
        run: |
          git add pyproject.toml CHANGELOG.md uv.lock README.md
          git commit -m "chore: prepare release $RELEASE_VERSION"

      - name: Create annotated tag
        run: git tag -a "$RELEASE_TAG" -m "Release $RELEASE_VERSION"

      - name: Push branch and tag
        env:
          PUSH_AND_RUN_WORKFLOW_TOKEN: ${{ env.PUSH_AND_RUN_WORKFLOW_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${PUSH_AND_RUN_WORKFLOW_TOKEN:-}" ]; then
            echo "PUSH_AND_RUN_WORKFLOW_TOKEN is not configured; cannot push release refs."
            exit 1
          fi
          git remote set-url origin "https://x-access-token:${PUSH_AND_RUN_WORKFLOW_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git push origin "$RELEASE_BRANCH"
          git push origin "$RELEASE_TAG"

      - name: Create pull request
        env:
          DEFAULT_GH_TOKEN: ${{ github.token }}
          PUSH_AND_RUN_WORKFLOW_TOKEN: ${{ secrets.PUSH_AND_RUN_WORKFLOW_TOKEN }}
        run: |
          set -euo pipefail
          GH_TOKEN="${PUSH_AND_RUN_WORKFLOW_TOKEN:-$DEFAULT_GH_TOKEN}"
          export GH_TOKEN
          existing="$(gh pr list --head "$RELEASE_BRANCH" --base main --state open --json number,url --jq '.[0]' || true)"
          if [ -n "$existing" ] && [ "$existing" != "null" ]; then
            pr_number="$(jq -r '.number' <<<"$existing")"
            pr_url="$(jq -r '.url' <<<"$existing")"
            echo "既存のプルリクエスト #$pr_number ($pr_url) が見つかりました。"
            {
              echo "PR_NUMBER=$pr_number"
              echo "PR_URL=$pr_url"
            } >> "$GITHUB_ENV"
            exit 0
          fi

          printf -v body '## 概要\n- Release version: %s\n- Tag: %s\n- Branch: %s\n' \
            "$RELEASE_VERSION" "$RELEASE_TAG" "$RELEASE_BRANCH"

          gh pr create \
            --base main \
            --head "$RELEASE_BRANCH" \
            --title "chore: release $RELEASE_VERSION" \
            --body "$body"

          created="$(gh pr list --head "$RELEASE_BRANCH" --base main --state open --json number,url --jq '.[0]')"
          if [ -z "$created" ] || [ "$created" = "null" ]; then
            echo "プルリクエストの作成に失敗しました。"
            exit 1
          fi
          pr_number="$(jq -r '.number' <<<"$created")"
          pr_url="$(jq -r '.url' <<<"$created")"
          {
            echo "PR_NUMBER=$pr_number"
            echo "PR_URL=$pr_url"
          } >> "$GITHUB_ENV"
          echo "プルリクエスト #$pr_number ($pr_url) を作成しました。"

      - name: Publish summary
        run: |
          {
            echo "## リリースブランチを作成しました"
            echo "- Current: \`$CURRENT_VERSION\`"
            echo "- Branch: \`$RELEASE_BRANCH\`"
            echo "- Tag: \`$RELEASE_TAG\`"
            echo "- Version: \`$RELEASE_VERSION\`"
            echo "- Bump: \`$VERSION_BUMP\`"
            echo "- Date: \`$RELEASE_DATE\`"
            if [ -n "${PR_URL:-}" ]; then
              echo "- PR: $PR_URL"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
